<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Allive - 함께하는 세상 올리브 | JS Blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="JeongShin 의 코딩 블로그 👨🏻‍💻">
    <meta name="google-site-verification" content="66JKoxw93huqhAdXO3P0K86NJZne5H-M3302YHcwoWI">
    <link rel="preload" href="/JeongShin_Blog/assets/css/0.styles.8bc6e67b.css" as="style"><link rel="preload" href="/JeongShin_Blog/assets/js/app.d2b9c418.js" as="script"><link rel="preload" href="/JeongShin_Blog/assets/js/2.20c94440.js" as="script"><link rel="preload" href="/JeongShin_Blog/assets/js/3.3ed94c34.js" as="script"><link rel="prefetch" href="/JeongShin_Blog/assets/js/10.82c67914.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/11.39fe8bc4.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/12.987ef25c.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/13.16da5986.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/14.6c73ec6b.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/15.16277415.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/16.2102efd8.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/17.671a9be6.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/18.561cf7df.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/19.07d068ec.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/20.8945de34.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/21.795d85af.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/22.ffb6b47d.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/23.eda34ff6.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/24.82c4257f.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/4.c8d338e9.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/5.ab08a565.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/6.3798c24e.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/7.5f6b3da9.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/8.f9e33ce9.js"><link rel="prefetch" href="/JeongShin_Blog/assets/js/9.0cd03083.js">
    <link rel="stylesheet" href="/JeongShin_Blog/assets/css/0.styles.8bc6e67b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/JeongShin_Blog/" class="home-link router-link-active"><img src="/JeongShin_Blog/images/logo.jpg" alt="JS Blog" class="logo"> <span class="site-name can-hide">JS Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/JeongShin_Blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/JeongShin_Blog/home/" class="nav-link">
  
</a></div><div class="nav-item"><a href="/JeongShin_Blog/aboutme/" class="nav-link">
  About me
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/JeongShin_Blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/JeongShin_Blog/home/" class="nav-link">
  
</a></div><div class="nav-item"><a href="/JeongShin_Blog/aboutme/" class="nav-link">
  About me
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/JeongShin_Blog/guide/" class="sidebar-link">Guide</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/JeongShin_Blog/Projects/" class="sidebar-heading clickable router-link-active open"><span>Projects</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/JeongShin_Blog/Projects/Allive/" aria-current="page" class="active sidebar-link">Allive - 함께하는 세상 올리브</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JeongShin_Blog/Projects/Allive/#intro-프로젝트-소개" class="sidebar-link">Intro. 프로젝트 소개</a></li><li class="sidebar-sub-header"><a href="/JeongShin_Blog/Projects/Allive/#note-1-serverless-graphql-chat-api" class="sidebar-link">Note 1. Serverless Graphql Chat API</a></li><li class="sidebar-sub-header"><a href="/JeongShin_Blog/Projects/Allive/#note-2-custom-event" class="sidebar-link">Note 2. Custom Event</a></li><li class="sidebar-sub-header"><a href="/JeongShin_Blog/Projects/Allive/#note-3-toast-만들기" class="sidebar-link">Note 3. Toast 만들기</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/JeongShin_Blog/algorithms/" class="sidebar-heading clickable"><span>Algorithms</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="allive-함께하는-세상-올리브"><a href="#allive-함께하는-세상-올리브" class="header-anchor">#</a> Allive - 함께하는 세상 올리브</h1> <h2 id="intro-프로젝트-소개"><a href="#intro-프로젝트-소개" class="header-anchor">#</a> Intro. 프로젝트 소개</h2> <p>올리브 프로젝트 소개 및 프론트 엔드 개발 회고 입니다 😁</p> <p>프론트엔드 개발하면서 있었던 <strong>큰건 없고 사소하고 하찮은 고민에 대한 회고</strong>를 남겨두기 위함 입니다 ✍️</p> <h4 id="랜딩-페이지-올리브-랜딩-페이지-링크"><a href="#랜딩-페이지-올리브-랜딩-페이지-링크" class="header-anchor">#</a> 랜딩 페이지 : <a href="https://all-live.github.io/" target="_blank" rel="noopener noreferrer">올리브 랜딩 페이지 링크<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h4> <p>TODO: 모바일 대응</p> <h4 id="올리브는-어떤-프로젝트-인가요-🙋🏻"><a href="#올리브는-어떤-프로젝트-인가요-🙋🏻" class="header-anchor">#</a> 올리브는 어떤 프로젝트 인가요 🙋🏻</h4> <p>올리브 프로젝트 (<strong>Allive</strong>, <strong>All Live Together</strong>)는 2021년 3월부터 기획 및 기술 스택 스터디, 9월부터 본격적인 개발에 들어간 <strong>재능나눔 어플</strong> 프로젝트 입니다.</p> <p>대학교 4학년 개발자 2명이서 학과 공부 및 회사 업무와 병행하며 퇴근 후, 주말 시간 등을 활용하여 열정을 불 태우며 개발중인 프로젝트 입니다. 🔥</p> <div class="center"><img src="/JeongShin_Blog/assets/img/allive_guide_3.c0a753c1.png" width="300" height="auto"> <img src="/JeongShin_Blog/assets/img/allive_guide_1.acb18f2c.png" width="300" height="auto"> <img src="/JeongShin_Blog/assets/img/allive_guide_2.7fb6658a.png" width="300" height="auto"></div> <p>개발자 소개 입니다.</p> <ul><li><p>👨🏻‍💻 프론트 엔드 개발 - 신정웅 <a href="https://github.com/JeongShin" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>👨🏻‍💻 백엔드 개발 - 이신육 <a href="https://github.com/leeshinyook" target="_blank" rel="noopener noreferrer">github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <h4 id="프론트엔드-app-기술스택"><a href="#프론트엔드-app-기술스택" class="header-anchor">#</a> 프론트엔드 App 기술스택</h4> <ul><li><p>React Native</p></li> <li><p>Styled Components Native</p></li> <li><p>Recoil js</p></li> <li><p>Firebase (Cloud Messaging, Crashlytics, Analytics)</p></li></ul> <h4 id="프론트엔드-web-기술스택"><a href="#프론트엔드-web-기술스택" class="header-anchor">#</a> 프론트엔드 Web 기술스택</h4> <ul><li>Next js -&gt; 스택만 next 지 ssr 은 사용 못했음 (안했음)..</li></ul> <h4 id="백엔드-기술스택"><a href="#백엔드-기술스택" class="header-anchor">#</a> 백엔드 기술스택</h4> <ul><li><p>Java Spring</p></li> <li><p>AWS - elasticsearch</p></li> <li><p>Swagger</p></li> <li><p>Serverless Graphql API</p></li></ul> <h4 id="프로젝트-진행상황"><a href="#프로젝트-진행상황" class="header-anchor">#</a> 프로젝트 진행상황</h4> <table><thead><tr><th></th> <th>iOS</th> <th>Android</th> <th>Web</th></tr></thead> <tbody><tr><td>1차 배포 - 버전 1.0</td> <td>배포 완료 ✅</td> <td>배포 완료 ✅</td> <td>배포 완료 ✅</td></tr> <tr><td>2차 배포 - 버전 1.1</td> <td>2021.12 예정</td> <td>2021.12 예정</td> <td>2021.12 예정</td></tr></tbody></table> <p>2차 배포를 마무리로 프로젝트 마무리 될 예정 입니다.</p> <h2 id="note-1-serverless-graphql-chat-api"><a href="#note-1-serverless-graphql-chat-api" class="header-anchor">#</a> Note 1. Serverless Graphql Chat API</h2> <p>채팅 구현을 앞두고 협업중인 백엔드 친구에게 채팅 서버를 개발 해보겠다고 하고 테스크를 맡았다.</p> <p>스택은 여러가지 고민을 하다가 <code>Appsync</code> <code>Aurora postgres</code> <code>lambda</code> 로 구성을 하였고 cdk 코드 작성 후 배포 했다. 그냥 개발 단계부터 열정적으로다가 돈이 많이 든다.. 😵‍💫</p> <p>appsync 는 <code>amplify</code> 등을 통해서 쉽게 스키마를 설계하고 자동으로 생성되는 <code>resolver</code> 를 사용할 수 있지만 커스터마이징이 어렵고 개발하면서 코드를 짜는 시간보다 <strong>aws vtl</strong> 등 문법을 찾아보거나 stack overflow 만 하루종일 뒤지는거보다 lambda 에 커스텀 resolver 를 사용해서 코딩하는 시간을 많이 쏟는게 더 좋았고 그렇게 시작해보았다.</p> <p>개인적으로 aws 도큐가 너무 읽기 어렵다..</p> <h3 id="resolver-🏄‍♂️"><a href="#resolver-🏄‍♂️" class="header-anchor">#</a> Resolver 🏄‍♂️</h3> <p>아래는 람다 index.ts 코드 일부이다. 각각의 graphql query 에 resolver 함수를 매핑 해주었다. 여기까진 아주 순조로웠다.</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>event<span class="token operator">:</span> AppSyncEvent<span class="token punctuation">,</span> _<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">param<span class="token operator">:</span> <span class="token builtin">unknown</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> token <span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">.</span>arguments<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'TOKEN NOT FOUND'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> uid <span class="token punctuation">}</span> <span class="token operator">=</span> jwtDecode<span class="token operator">&lt;</span><span class="token punctuation">{</span> uid<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uid<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'USER NOT AUTHENTICATED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>info<span class="token punctuation">.</span>fieldName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'createMe'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">createMe</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>createMeInput<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'createMessage'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">createMessage</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>messageInput<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'createChatRoom'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">createChatRoom</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>chatroomInput<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'listChatRooms'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">listChatRooms</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'listMessages'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">listMessages</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>listMessageInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'getChatRoom'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">getChatRoom</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>chatroomId<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'joinChatRoom'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">joinChatRoom</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>chatroomId<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'updateUserChatRoom'</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">updateUserChatRoom</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>arguments<span class="token punctuation">.</span>userChatRoomInput<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'RESOLVER NOT FOUND'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="pagination-✂️"><a href="#pagination-✂️" class="header-anchor">#</a> Pagination ✂️</h3> <p><code>listMessages</code> resolver 에서 pagination 을 어떻게 구현할지 고민이였다. 우선 custom lambda 로 시작한 이상 직접 구현해야 했다. 기존에 Rails Backend 개발할때</p> <div class="language-RB line-numbers-mode"><pre class="language-rb"><code>  posts <span class="token operator">=</span> posts<span class="token punctuation">.</span>page<span class="token punctuation">(</span>cursor<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>와 같이 라이브러리에 의존해왔고 아무래도 백엔드 개발을 많이 안해본데다 쿼리를 LIMIT, OFFSET 등을 이용해서 구현하기도 애매했다.</p> <p>sql 쿼리를 짜기 어려운거보다 page 별로 데이터 가져오다 도중에 상대가 메시지 보내서 추가되면 어떻게 처리해야하지?</p> <p>pagination 이 밀림 없이 되나? 이런 고민들이 있는데 당장 모르겠어서 내게 익숙한 js 쪽에 로직을 더 집중하여서 코드를 구현 해봤다.</p> <p>방법은 column id 값을 이용해서 가져온 데이터까지만 limit 으로 자르고 다음 페이지 정보와 함께 다음으로 처음 읽을 데이터의 id 값을 넘겨주는 식으로 구현했다.</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">listMessages</span><span class="token punctuation">(</span><span class="token parameter">listMessageInput<span class="token operator">:</span> ListMessagesInput</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> chatroomId<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> cursor <span class="token punctuation">}</span> <span class="token operator">=</span> listMessageInput<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> records <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      SELECT *
      FROM messages
      INNER JOIN users
      ON users.useruid = messages.useruid
      WHERE messages.chatroomid = :chatroomId
      ORDER BY messages.createdat DESC
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      chatroomId<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 일단 chatroomId 기반으로 모든 메시지를 긁어 온다. 뭐 메시지 정말 많아봐야 몇백개쯤 될텐데 </span>
  <span class="token comment">// 우선 우리 서비스에는 큰 문제가 없으리라 생각 된다. </span>
  <span class="token comment">// 이제 js 단에서 pagination 을 처리</span>

  <span class="token keyword">return</span> paginate<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span><span class="token punctuation">(</span>records<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    limit<span class="token punctuation">,</span>
    cursor<span class="token punctuation">,</span>
    column<span class="token operator">:</span> <span class="token string">'messageid'</span><span class="token punctuation">,</span>
    map<span class="token operator">:</span> mapMessage<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// utils.ts</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PageInfo</span> <span class="token punctuation">{</span>
  nextCursor<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  hasNextPage<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  totalCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">PaginateResult</span><span class="token operator">&lt;</span>Output<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  pageInfo<span class="token operator">:</span> PageInfo<span class="token punctuation">;</span>
  items<span class="token operator">:</span> Output<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> paginate <span class="token operator">=</span> <span class="token operator">&lt;</span>Output<span class="token operator">&gt;</span><span class="token punctuation">(</span>records<span class="token operator">:</span> AnyObject<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> params<span class="token operator">:</span> PaginateParams<span class="token operator">&lt;</span>Output<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> PaginateResult<span class="token operator">&lt;</span>Output<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> limit<span class="token punctuation">,</span> cursor<span class="token punctuation">,</span> column<span class="token punctuation">,</span> map <span class="token punctuation">}</span> <span class="token operator">=</span> params<span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token punctuation">[</span>startIdx<span class="token punctuation">,</span> lastIdx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> records<span class="token punctuation">.</span>reduce<span class="token operator">&lt;</span>PaginateResult<span class="token operator">&lt;</span>Output<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> curr<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>cursor <span class="token operator">&amp;&amp;</span> index <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">||</span> curr<span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">===</span> cursor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>startIdx<span class="token punctuation">,</span> lastIdx<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>index<span class="token punctuation">,</span> index <span class="token operator">+</span> limit<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>startIdx <span class="token operator">&lt;=</span> index <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> lastIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        acc<span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">map</span><span class="token punctuation">(</span>curr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> lastIdx <span class="token operator">&amp;&amp;</span> records<span class="token punctuation">[</span>lastIdx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        acc<span class="token punctuation">.</span>pageInfo<span class="token punctuation">.</span>nextCursor <span class="token operator">=</span> records<span class="token punctuation">[</span>lastIdx<span class="token punctuation">]</span><span class="token punctuation">[</span>column<span class="token punctuation">]</span><span class="token punctuation">;</span>
        acc<span class="token punctuation">.</span>pageInfo<span class="token punctuation">.</span>hasNextPage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> acc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> pageInfo<span class="token operator">:</span> <span class="token punctuation">{</span> nextCursor<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hasNextPage<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> totalCount<span class="token operator">:</span> records<span class="token punctuation">.</span>length <span class="token punctuation">}</span><span class="token punctuation">,</span> items<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>살짝 알고리즘 짜는 느낌이였지만 결과는 대성공 이였다.</p> <p>아... 알고리즘 공부 언제하지 ㅠㅠ</p> <h3 id="최적화"><a href="#최적화" class="header-anchor">#</a> 최적화..?</h3> <p>cloud watch 로 확인 했을때 대부분의 api 요청이 30 ~ 60 ms 내에 처리 되었다. lambda 가 <strong>cold start</strong> 일때 평균 500ms 인걸 제외하면 생각한거보다 속도가 빨라서 아주 만족스러웠다.</p> <p>문제는 <code>createMessage</code> 에서 처리해줘야 할게 많아서 평균 400 ~ 800 ms 응답 속도가 나왔는데</p> <ol><li>userchatrooms unReadCnt 컬럼값 업데이트 (상대방 읽지 않은 수)</li> <li>fcm 처리</li> <li>chatroom lastMessage, lastMessagedAt 컬럼값 업데이트</li></ol> <p>를 해줘야 했다. 먼저 <code>Promise.all</code> 을 통한 병렬처리를 해줬지만 그래도 그나마 향상된게 300ms ~ 500ms 인데 결국 유저 입장에서는 이 또한 메시지가 바로가지 않기 때문에 답답함을 느낄 수 있다 생각 되었다. (일단 나는 답답했다).</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token parameter">messageInput<span class="token operator">:</span> CreateMessageInput<span class="token punctuation">,</span> userUid<span class="token operator">:</span> <span class="token builtin">string</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 생략</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token punctuation">{</span>
    messageId<span class="token operator">:</span> messageId <span class="token operator">||</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    body<span class="token punctuation">,</span>
    userUid<span class="token punctuation">,</span>
    createdAt<span class="token operator">:</span> now<span class="token punctuation">,</span>
    chatroomId<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
      <span class="token string">'INSERT INTO messages (messageid,body,useruid,createdat,chatroomid) VALUES(:messageId,:body,:userUid,:createdAt,:chatroomId)'</span><span class="token punctuation">,</span>
      message<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">UPDATE chatrooms SET lastmessage = :body, lastmessageat = :now WHERE chatroomid = :chatroomId</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      body<span class="token punctuation">,</span>
      now<span class="token punctuation">,</span>
      chatroomId<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">mapFcmPromises</span><span class="token punctuation">(</span>chatroom<span class="token punctuation">,</span> me<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token function">mapUpdateUserChatRoomPromises</span><span class="token punctuation">(</span>chatroom<span class="token punctuation">,</span> me<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>message<span class="token punctuation">,</span> writer<span class="token operator">:</span> me <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>결국 마지막 최후의 수단은 어차피 서버에서 문제 없이 메시지가 간다고 가정하고 프론트 단에서 처리를 해줘야겠다 생각을 바꿨다.</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> messageSubmitHandler <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> body <span class="token punctuation">}</span><span class="token operator">:</span> MessageBarForm</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> messageId <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">v4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> message<span class="token operator">:</span> Message <span class="token operator">=</span> <span class="token punctuation">{</span>
      writer<span class="token operator">:</span> <span class="token punctuation">{</span>
        userId<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>currentUser<span class="token punctuation">.</span>userId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        userUid<span class="token operator">:</span> currentUser<span class="token punctuation">.</span>userUid<span class="token punctuation">,</span>
        nickname<span class="token operator">:</span> currentUser<span class="token punctuation">.</span>nickname<span class="token punctuation">,</span>
        deviceToken<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        profile<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      body<span class="token punctuation">,</span>
      messageId<span class="token punctuation">,</span>
      chatroomId<span class="token punctuation">,</span>
      createdAt<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 우선 메시지가 문제없이 생기리라 가정하고 message list 에 추가</span>
    queryClient<span class="token punctuation">.</span>setQueryData<span class="token operator">&lt;</span>PaginateResult<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>messagesQueryKey<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
      prev
        <span class="token operator">?</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>prev<span class="token punctuation">,</span>
            items<span class="token operator">:</span> <span class="token punctuation">[</span>message<span class="token punctuation">,</span> <span class="token operator">...</span>prev<span class="token punctuation">.</span>items<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token operator">:</span> prev<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// API 요청</span>
    <span class="token keyword">await</span> ChatApi<span class="token punctuation">.</span>Message<span class="token punctuation">.</span><span class="token function">createMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> body<span class="token punctuation">,</span> chatroomId<span class="token punctuation">,</span> messageId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 성공하면 createdAt 을 기반으로 다시 sorting 해줄 수 있지만 도중에 순서가 섞일 정도로 채팅이 활발할까</span>
    <span class="token comment">// 싶기도 하고 100 ~ 200 ms 사이에 동시에 보내진 메시지가 잠깐 순서가 바뀌어 보여도 크게 사용자 경험을 해치진 않는다 생각한다. </span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="message-ui-처리"><a href="#message-ui-처리" class="header-anchor">#</a> Message UI 처리</h3> <p>개인적으로 이번 채팅서버 개발동안 제일 재밌었던 부분.</p> <p>RN 에서 <strong>react-native-gifted-chat</strong> 이라는 라이브러리가 있긴 하지만 또 직접 구현하기로 마음 먹었다.</p> <p>살짝 까다로웠던게 프로필은 올라가고 날짜는 동일하면 내려가고 등 앞, 뒤 메시지에 따른 뷰처리인데</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">const</span> renderItem<span class="token operator">:</span> ListRenderItem<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> item<span class="token operator">:</span> currMessage<span class="token punctuation">,</span> index <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isMyMessage <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>currMessage<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>userId<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">Number</span><span class="token punctuation">(</span>myUserId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextMessage <span class="token operator">=</span> messages<span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevMessage <span class="token operator">=</span> messages<span class="token punctuation">[</span>index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> prevYYYYMd <span class="token operator">=</span> prevMessage <span class="token operator">?</span> <span class="token function">format</span><span class="token punctuation">(</span>prevMessage<span class="token punctuation">.</span>createdAt <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TIME_FORMAT</span><span class="token punctuation">.</span>YYYYMd<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currYYYYMd <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>currMessage<span class="token punctuation">.</span>createdAt <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TIME_FORMAT</span><span class="token punctuation">.</span>YYYYMd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> prevHHmm <span class="token operator">=</span> prevMessage <span class="token operator">?</span> <span class="token function">format</span><span class="token punctuation">(</span>prevMessage<span class="token punctuation">.</span>createdAt <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TIME_FORMAT</span><span class="token punctuation">.</span>HHmm<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> currHHmm <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span>currMessage<span class="token punctuation">.</span>createdAt <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">TIME_FORMAT</span><span class="token punctuation">.</span>HHmm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> isNextDiffUser <span class="token operator">=</span> nextMessage <span class="token operator">?</span> nextMessage<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>userId <span class="token operator">!==</span> currMessage<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>userId <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> isPrevDiffUser <span class="token operator">=</span> prevMessage <span class="token operator">?</span> prevMessage<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>userId <span class="token operator">!==</span> currMessage<span class="token punctuation">.</span>writer<span class="token punctuation">.</span>userId <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> isMyMessage <span class="token operator">?</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>MyMessageBubble
        message<span class="token operator">=</span><span class="token punctuation">{</span>currMessage<span class="token punctuation">}</span>
        currHHmm<span class="token operator">=</span><span class="token punctuation">{</span>currHHmm<span class="token punctuation">}</span>
        currYYYYMd<span class="token operator">=</span><span class="token punctuation">{</span>currYYYYMd<span class="token punctuation">}</span>
        isNextDiffUser<span class="token operator">=</span><span class="token punctuation">{</span>isPrevDiffUser<span class="token punctuation">}</span>
        isHHmmDiff<span class="token operator">=</span><span class="token punctuation">{</span>currHHmm <span class="token operator">!==</span> prevHHmm <span class="token operator">||</span> isPrevDiffUser<span class="token punctuation">}</span>
        isDiffDate<span class="token operator">=</span><span class="token punctuation">{</span>currYYYYMd <span class="token operator">!==</span> prevYYYYMd <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>prevMessage<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>OtherMessageBubble
        message<span class="token operator">=</span><span class="token punctuation">{</span>currMessage<span class="token punctuation">}</span>
        currHHmm<span class="token operator">=</span><span class="token punctuation">{</span>currHHmm<span class="token punctuation">}</span>
        currYYYYMd<span class="token operator">=</span><span class="token punctuation">{</span>currYYYYMd<span class="token punctuation">}</span>
        isNextDiffUser<span class="token operator">=</span><span class="token punctuation">{</span>isNextDiffUser<span class="token punctuation">}</span>
        isHHmmDiff<span class="token operator">=</span><span class="token punctuation">{</span>currHHmm <span class="token operator">!==</span> prevHHmm <span class="token operator">||</span> isPrevDiffUser<span class="token punctuation">}</span>
        isDiffDate<span class="token operator">=</span><span class="token punctuation">{</span>currYYYYMd <span class="token operator">!==</span> prevYYYYMd <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>prevMessage<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>messages<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>요런식으로 한번 해봤고</p> <div class="center"><img src="/JeongShin_Blog/assets/img/chat1.b8e32f39.png" width="300" height="auto"> <img src="/JeongShin_Blog/assets/img/chat2.74e64219.png" width="300" height="auto"> <img src="/JeongShin_Blog/assets/img/chat3.41ba712f.png" width="300" height="auto"></div> <p>생각보다 이쁘게 잘나온다. 나중에 시간되면 사진 업로드까지 붙이고 싶긴하다.</p> <p>이제 단톡방 구현 해야지...</p> <h2 id="note-2-custom-event"><a href="#note-2-custom-event" class="header-anchor">#</a> Note 2. Custom Event</h2> <p>RN 환경에서 개발을 하다가 <code>Custom Event</code> 를 발생시켜야 하는 상황이 생겼다.</p> <p>인스타그램과 같은 앱에서 하단 탭을 여러번 탭하거나 로고를 누르는 경우 스크롤을 쭉 올려주는 구현을 하고 싶었다.</p> <h3 id="문제점"><a href="#문제점" class="header-anchor">#</a> 문제점</h3> <ul><li>하단 탭 컴포넌트와 리스트 컴포넌트가 완전히 분리된 컴포넌트이기 때문에 소통할 수 있는 구조가 아니였다.</li> <li>Node Module <strong>events</strong> 를 사용해서 커스텀 이벤트를 발생시켜 구현하고 싶었지만 React Native 환경에서는 기본 모듈이 없다.</li> <li>다른 라이브러리 찾아서 쓸까 고민 했지만 그냥 커스텀으로 만들어 보기로 결정했다.</li> <li>RN 코어 라이브러리를 제외하고는 다른 라이브러리 사용을 최소화하기 위한 노력이다.. ㅎㅎ</li></ul> <h3 id="해결방안"><a href="#해결방안" class="header-anchor">#</a> 해결방안</h3> <p>일단 기본적인 <code>addEventListener</code> 와 클린업을 위한 <code>removeEventListener</code> 만 러프하게 작성해보았다.</p> <div class="language-JS line-numbers-mode"><pre class="language-js"><code>type <span class="token function-variable function">Callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token operator">?</span><span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EventClass</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> Listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span> Callback<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string<span class="token punctuation">,</span> callback<span class="token operator">:</span> Callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>isNameString<span class="token punctuation">,</span> isCallbackFn<span class="token punctuation">,</span> isExists<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token keyword">typeof</span> name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
      EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNameString <span class="token operator">||</span> <span class="token operator">!</span>isCallbackFn <span class="token operator">||</span> isExists<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> name <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string<span class="token punctuation">,</span> args<span class="token operator">?</span><span class="token operator">:</span> unknown</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> EventClass<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>이제 BottomTabs 에서 같은 탭을 두번 클릭하게 되는 경우 이벤트를 발생 시킨다.</p> <div class="language-JS line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@all-live'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> BottomTabBar<span class="token operator">:</span> React<span class="token punctuation">.</span><span class="token constant">FC</span><span class="token operator">&lt;</span>BottomTabBarProps<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> navigation<span class="token punctuation">,</span> state <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> onTabPressHandler <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">currIdx<span class="token operator">:</span> number<span class="token punctuation">,</span> idx<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currIdx <span class="token operator">!==</span> idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        navigation<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>routes<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currIdx <span class="token operator">===</span> <span class="token constant">BOTTOM_TABS</span><span class="token punctuation">.</span><span class="token constant">HOME_TAB_SCREEN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 두번 연속으로 같은 탭을 탭하는 경우 이벤트 발생</span>
        Event<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'scrollFlatListToTop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 생략</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>리스트 컴포넌트에선 이벤트 리스너를 등록해준다.</p> <div class="language-JS line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Event <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@all-live'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> AllTalentList<span class="token operator">:</span> <span class="token constant">FC</span><span class="token operator">&lt;</span>AllTalentListProps<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> navigation <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flatListRef <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>FlatList<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> onScrollToTopHandler <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    flatListRef<span class="token punctuation">.</span>current<span class="token operator">?.</span><span class="token function">scrollToOffset</span><span class="token punctuation">(</span><span class="token punctuation">{</span> animated<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 이벤트 리스너 등록</span>
    Event<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scrollFlatListToTop'</span><span class="token punctuation">,</span> onScrollToTopHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 클린업</span>
      Event<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'scrollFlatListToTop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 생략</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>동작이 잘되는걸 확인하고 나서 타입 적용을 시작했다.</p> <p>목표는 아래와 같다.</p> <ol><li><p>이벤트 이름 강제 시</p></li> <li><p>이벤트 이름에 따라 콜백에 인자가 있는 경우 인자 타입 정의</p></li></ol> <p>코드가 그렇게 길지 않아서 전체코드를 올리자면</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 여기 인터페이스를 기반으로 인자 타입을 결정 해준다.</span>
<span class="token keyword">interface</span> <span class="token class-name">CustomEvents</span> <span class="token punctuation">{</span>
  <span class="token comment">// 이벤트 이름: 인자 타입</span>
  scrollFlatListToTop<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Callback<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span> Partial<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> EventNames <span class="token operator">=</span> Extract<span class="token operator">&lt;</span><span class="token keyword">keyof</span> CustomEvents<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">EventClass</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> Listeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> addEventListener<span class="token operator">&lt;</span>EventName <span class="token keyword">extends</span> <span class="token class-name">keyof</span> CustomEvents <span class="token operator">=</span> EventNames<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    name<span class="token operator">:</span> EventName<span class="token punctuation">,</span>
    callback<span class="token operator">:</span> Callback<span class="token operator">&lt;</span>CustomEvents<span class="token punctuation">[</span>EventName<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>isNameString<span class="token punctuation">,</span> isCallbackFn<span class="token punctuation">,</span> isExists<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token keyword">typeof</span> name <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
      EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNameString <span class="token operator">||</span> <span class="token operator">!</span>isCallbackFn <span class="token operator">||</span> isExists<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> EventNames</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> name <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">removeAllEventListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> emit<span class="token operator">&lt;</span>EventName <span class="token keyword">extends</span> <span class="token class-name">keyof</span> CustomEvents <span class="token operator">=</span> EventNames<span class="token operator">&gt;</span><span class="token punctuation">(</span>name<span class="token operator">:</span> EventName<span class="token punctuation">,</span> args<span class="token operator">?</span><span class="token operator">:</span> CustomEvents<span class="token punctuation">[</span>EventName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> EventClass<span class="token punctuation">.</span>Listeners<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> EventClass<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>와 같이 해주었고 타입 적용이 잘 되고 있는지 확인 해보았다.</p> <p>타입이 잘 적용 되는지 테스트 하기 위해 인터페이스를 아래와 같이 변경</p> <div class="language-TS line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">CustomEvents</span> <span class="token punctuation">{</span>
  scrollFlatListToTop<span class="token operator">:</span> <span class="token punctuation">{</span> myParam<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>emit 하는 부분</strong></p> <div class="center"><img src="/JeongShin_Blog/assets/img/type_test1.d21debdd.png" width="100%" height="auto"></div> <p><strong>callback 등록하는 부분</strong></p> <div class="center"><img src="/JeongShin_Blog/assets/img/type_test2.d6f309e1.png" width="100%" height="auto"></div> <p>잘된다 ㅎㅎ</p> <h3 id="결과"><a href="#결과" class="header-anchor">#</a> 결과</h3> <p>거의 뇌피셜로 구현해서 이렇게 하는게 맞는지 모르겠는데 기능은 대충 흉내낸거 같다.</p> <div class="center"><img src="/JeongShin_Blog/assets/img/custom_events.gif.7801c768.gif" width="300" height="600"></div> <h2 id="note-3-toast-만들기"><a href="#note-3-toast-만들기" class="header-anchor">#</a> Note 3. Toast 만들기</h2> <p>Toast Modal 을 커스텀하게 제작해서 사용하고 있는데 문제점이 있었다.</p> <h3 id="문제점-🚨"><a href="#문제점-🚨" class="header-anchor">#</a> 문제점 🚨</h3> <p>Toast Modal 이 떠있는 동안 화면을 제어하지 못한다.</p> <p>문제가 발생한 이유는 <code>navigation</code> 을 이용해서 <strong>transparent modal</strong> 로 화면 이동을 해서 하는 방식으로 구현을 했는데 아래 요구사항을 쉽게 만족하기 위해서였다.</p> <h3 id="요구사항-💭"><a href="#요구사항-💭" class="header-anchor">#</a> 요구사항 💭</h3> <div class="language- extra-class"><pre><code>✅ Toast Modal 이 생겼다가 일정시간 이후 자동으로 사라져야함
✅ 애니매이션 (fade in, out) 효과가 있어야함
✅ 화면 뒤에 컨텐츠가 보여야 함
❌ 화면 제어가 가능해야함 → 문제 발생😱
</code></pre></div><p>4번 문제를 일단 냅두고 1차 배포를 했는데 이제 해결하기 위한 방법을 생각해보았다.</p> <h3 id="해결방안-🤔"><a href="#해결방안-🤔" class="header-anchor">#</a> 해결방안 🤔</h3> <p>기존 방식은 아래와 같이 navigation 을 통한 화면 이동이였다. 해당 방식으로는 애니메이션을 따로 코딩하지 않고 구현할 수 있어서 하였는데 4번 문제를 해결 할 수 없었다.</p> <div class="language-JS line-numbers-mode"><pre class="language-js"><code>navigation<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token string">'TOAST_MODAL'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> body<span class="token operator">:</span> <span class="token constant">TOAST_MESSAGES</span><span class="token punctuation">.</span><span class="token constant">TALENT</span><span class="token punctuation">.</span><span class="token constant">LIKED</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>제일 처음 떠올린 해결방안은 navigation 을 통한 화면 이동이 아닌 작은 컴포넌트를 띄워주는 방식으로 해결 하고자 하였다.</p> <p>부모 컴포넌트가 자식 컴포넌트를 제어해야하기 때문에 <strong><code>useImperativeHandle</code></strong> 을 활용 하였다.</p> <p>전체 코드는 아래와 같다.</p> <div class="language-tsx line-numbers-mode"><pre class="language-tsx"><code><span class="token keyword">type</span> Timer <span class="token operator">=</span> ReturnType<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>typeof</span> <span class="token attr-name">setTimeout</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">;

const TOAST_TIMEOUT_IN_MS = 1200;

const Toast = forwardRef</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ToastRef</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">((_, ref) =&gt; </span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> timer <span class="token operator">=</span> useRef<span class="token operator">&lt;</span>Timer <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> isAnimating <span class="token operator">=</span> useRef<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>boolean</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">(false);
  const </span><span class="token punctuation">{</span> bottomInset <span class="token punctuation">}</span><span class="token plain-text"> = useSafeArea();
  const animation = useRef(new Animated.Value(0)).current;

  const [body, setBody] = useState&lt;string | null&gt;(null);
  const [margin, setMargin] = useState</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>number</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">(0);

  const doneAnimatingCallback = useCallback(() =&gt; </span><span class="token punctuation">{</span>
    isAnimating<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token function">setBody</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">, []);

  const timeOutHandler = useCallback(() =&gt; </span><span class="token punctuation">{</span>
    Animated<span class="token punctuation">.</span><span class="token function">timing</span><span class="token punctuation">(</span>animation<span class="token punctuation">,</span> <span class="token punctuation">{</span> toValue<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> duration<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span> useNativeDriver<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>
      doneAnimatingCallback
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">, []);

  const onShowHandler = useCallback((toastProps: ToastProps) =&gt; </span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> timeOutInMs <span class="token operator">=</span> <span class="token constant">TOAST_TIMEOUT_IN_MS</span><span class="token punctuation">,</span> body<span class="token operator">:</span> toastBody <span class="token punctuation">}</span> <span class="token operator">=</span> toastProps<span class="token punctuation">;</span>
    <span class="token comment">// 이미 다른 toast 가 animating 중인 경우 다른 toast 는 억제</span>
    <span class="token comment">// 1. 큐에 넣어서 하나씩 처리할까 생각했지만 애매해서 중단</span>
    <span class="token comment">// 2. 기존 toast 를 취소하고 새로운 toast 를 띄워주는 방식도 가능할듯</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isAnimating<span class="token punctuation">.</span>current<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    isAnimating<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">setBody</span><span class="token punctuation">(</span>toastBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Animated<span class="token punctuation">.</span><span class="token function">timing</span><span class="token punctuation">(</span>animation<span class="token punctuation">,</span> <span class="token punctuation">{</span> toValue<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> duration<span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span> useNativeDriver<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timer<span class="token punctuation">.</span>current <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>timeOutHandler<span class="token punctuation">,</span> timeOutInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">, []);

  const imperativeHandler = useCallback(
    () =&gt; (</span><span class="token punctuation">{</span>
      show<span class="token operator">:</span> onShowHandler
    <span class="token punctuation">}</span><span class="token plain-text">),
    []
  );

  const onBodyLayoutHandler = useCallback((event: LayoutChangeEvent) =&gt; </span><span class="token punctuation">{</span>
    <span class="token comment">// container left margin 을 계산하기 위함</span>
    <span class="token keyword">const</span> containerWidth <span class="token operator">=</span> event<span class="token punctuation">.</span>nativeEvent<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> containerWidth <span class="token operator">!==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token function">setMargin</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">DIMENSIONS</span><span class="token punctuation">.</span><span class="token constant">WIDTH</span> <span class="token operator">-</span> containerWidth<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token plain-text">, []);

  useImperativeHandle(ref, imperativeHandler, []);

  return (
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span>body <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ToastStyle.Container</span></span>
          <span class="token attr-name">as</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>Animated<span class="token punctuation">.</span>View<span class="token punctuation">}</span></span>
          <span class="token attr-name">leftMargin</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>margin<span class="token punctuation">}</span></span>
          <span class="token attr-name">bottomInset</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>bottomInset<span class="token punctuation">}</span></span>
          <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> opacity<span class="token operator">:</span> animation <span class="token punctuation">}</span><span class="token punctuation">}</span></span>
        <span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ToastStyle.BodyView</span></span> <span class="token attr-name">onLayout</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>onBodyLayoutHandler<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">GlobalText.TextSmall</span></span> <span class="token attr-name">color</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>whiteColor<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>body<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">GlobalText.TextSmall</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ToastStyle.BodyView</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">ToastStyle.Container</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  );
});

const ToastStyle = </span><span class="token punctuation">{</span>
  Container<span class="token operator">:</span> Styled<span class="token punctuation">.</span>View<span class="token operator">&lt;</span>SafeAreaInsets <span class="token operator">&amp;</span> <span class="token punctuation">{</span> leftMargin<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    position: absolute;
    bottom: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> bottomInset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> theme <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> theme<span class="token punctuation">.</span>bottomTabBarHeight <span class="token operator">+</span> bottomInset <span class="token operator">+</span> <span class="token number">16</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px;
    margin-left: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> leftMargin <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> leftMargin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  BodyView<span class="token operator">:</span> Styled<span class="token punctuation">.</span>View<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    border-radius: 8px;
    background-color: #000000aa;
    padding: 16px;
  </span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token plain-text">;
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br></div></div><p>각각 요구사항에 대한 구현은 아래와 같이 진행함!</p> <ol><li><p>Toast Modal 이 생겼다가 일정시간 이후 자동으로 사라져야함</p> <p><code>imperativeHandler</code> 를 통해 부모 컴포넌트에서 <strong>onShowHandler</strong> 를 호출할 수 있도록 세팅,</p> <p><strong>setBody</strong> 를 통해 뷰가 나타나도록 하고 <strong>Animated API</strong> 를 통해 opacity 애니메이션으로 fade in 효과 구현</p> <p>animation 은 useNativeDriver 를 통해 네이티브로 넘김</p> <p>setTimeOut 을 통해 fade out animation 호출 후 콜백으로 다음 애니메이션 가능하도록 isAnimating 값 업데이트</p></li> <li><p>애니매이션 (fade in, out) 효과가 있어야함</p> <p>위에 설명한 <strong>Animated API</strong> 로 해결!</p></li> <li><p>화면 뒤에 컨텐츠가 보여야 함</p> <div class="language-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">const</span> CategoryTabScreen<span class="token operator">:</span> React<span class="token punctuation">.</span><span class="token constant">FC</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryTabScreenProps</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"> = ({ navigation }) =&gt; </span><span class="token punctuation">{</span>
  <span class="token comment">// toast 제어하기 위한 ref</span>
  <span class="token keyword">const</span> toastRef <span class="token operator">=</span> useRef <span class="token operator">&lt;</span> ToastRef <span class="token operator">&gt;</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> likePressHandler <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">subCategoryLikeInfo<span class="token operator">:</span> SubCategoryLikeInfo</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 생략</span>
        <span class="token comment">// show handler 호출</span>
        toastRef<span class="token punctuation">.</span>current<span class="token operator">?.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          body<span class="token operator">:</span> <span class="token function">getCategoryLikeToastBody</span><span class="token punctuation">(</span>subCategoryLikeInfo<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 생략</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">SafeAreaView</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">OtherComponents</span></span> <span class="token attr-name">likePressHandler</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>likePressHandler<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token punctuation">{</span><span class="token comment">/* SafeAreaView 에서 가장 앞쪽에 노출 되도록 */</span><span class="token punctuation">}</span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Toast</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>toastRef<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">SafeAreaView</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token plain-text">;
</span></code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div></li> <li><p>화면 제어가 가능해야함 👉 핵심 이슈!</p></li></ol> <p>Container 컴포넌트를 width: 100% 로 Text 컴포넌트를 margin: 0 auto 와 같이 해줄 수 있지만 아래 그림과 같은 영역 터치가 불가능 해진다.</p> <div class="center"><img src="/JeongShin_Blog/assets/img/toast.5b836feb.png" width="300" height="auto"></div> <p>따라서 container width 는 토스트 가로 길이에 딱 맞도록 하고 margin-left 속성을 동적으로 조절 해주는 방향으로 진행했다. 토스트를 제외한 모든 영역 터치가 가능하게 하도록 하기 위함이다.</p> <p><code>onBodyLayoutHandler</code> 를 통해 body 에 따른 뷰의 가로 길이를 계산해서 container margin-left 값을 동적으로 조절.</p> <div class="center"><img src="/JeongShin_Blog/assets/img/toast_screen.2277a9a0.png" width="300" height="auto"></div> <p>잘 적용된 모습. 끝~!</p> <p><s>개발자 입장에선 많은 변화가 있었지만 사용자들은 해당 이슈가 있는지도 모를때가 많다..ㅎㅎ</s></p> <p>그래도 나만 만족하면 됨</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/JeongShin_Blog/guide/" class="prev">
        Guide
      </a></span> <span class="next"><a href="/JeongShin_Blog/algorithms/Problems/">
        알고리즘 정리 노트
      </a>
      →
    </span></p></div>  <div><div id="comment"></div></div></main> <footer class="siteFooter">
  COPYRIGHT©2020 ALL RIGHT JeongShin
  <br>sjeong1127@gmail.com . +82-10-2169-2142 .
  <br> <a href="https://www.instagram.com/jeongshin96/" target="_blank">Instagram</a> <a href="https://github.com/JeongShin" target="_blank">GitHub</a></footer></div><div class="global-ui"></div></div>
    <script src="/JeongShin_Blog/assets/js/app.d2b9c418.js" defer></script><script src="/JeongShin_Blog/assets/js/2.20c94440.js" defer></script><script src="/JeongShin_Blog/assets/js/3.3ed94c34.js" defer></script>
  </body>
</html>
